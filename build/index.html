<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>AMP - Js Client</title>

    <!-- AMP Client -->
    <script src="./amp-client.js" type="text/javascript"></script>

    <!-- Splide slider -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>

    <!-- Swiper slider -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">

    <!-- Custom styles -->
    <style>
        .container {
            max-width: 1000px;
            text-align: center;
            margin: 0 auto;
        }

        .amp-banner__content {
            display: block;
        }

        .amp-banner__content--img > img {
            max-width: 100%;
            height: auto;
        }

        .amp-banner__list {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        .splide__pagination__page {
            background-color: #ccc !important;
        }
        .splide__pagination__page.is-active, .splide__arrow {
            background-color: #fff !important;
        }
    </style>

    <!-- AMP Client initialization -->
    <script>
        var AMPClient = AMPClientFactory.create({
            url: 'http://localhost:8888',
            channel: 'amp-demo',
            resources: {
                role: 'guest'
            },
            metrics: {
                receiver: (eventName, eventArgs) => {
                    console.log('Sending metrics.', {eventName, eventArgs});
                },
            }
        });

        // Events, dump info to the console
        AMPClient.on(AMPClient.EVENTS.ON_BANNER_ATTACHED, function (banner) {
            console.log('Banner on position ' + banner.position + ' was attached.');
        });

        AMPClient.on(AMPClient.EVENTS.ON_BANNER_STATE_CHANGED, function (banner) {
            console.log('State for banner on position ' + banner.position + ' was changed to ' + banner.state + '. Info: ' + banner.stateInfo);
        });

        AMPClient.on(AMPClient.EVENTS.ON_BEFORE_FETCH, function () {
            console.log('Before fetch.');
        });

        AMPClient.on(AMPClient.EVENTS.ON_FETCH_SUCCESS, function (response) {
            console.log(response);
        });

        AMPClient.on(AMPClient.EVENTS.ON_FETCH_ERROR, function (response) {
            console.log('Fetch error! ' + response.data.code + ': ' + response.data.error);
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>Banners:</h1>
        <div>
            <h2>First (added manually, single):</h2>
            <div id="banner1"></div>
            <script>
                AMPClient.createBanner('#banner1', 'homepage.center_left');
            </script>
        </div>
        <div>
            <h2>Second (added manually, random):</h2>
            <div id="banner2"></div>
            <script>
                AMPClient.createBanner(document.getElementById('banner2'), 'homepage.info_box_1', {
                    role: ['vip'],
                    product: "shop/buy-iphone/iphone-xs"
                });
            </script>
        </div>
        <div>
            <h2>Third (added via data-* attributes, multiple):</h2>
            <div data-amp-banner="homepage.top" data-amp-resource-roles="employee, vip" data-amp-resource-apple_products="shop/buy-iphone/iphone-xs" class="slider--splide"></div>
        </div>
    </div>

    <!-- Sliders initialization + attach and fetch banners -->
    <script>
        function initSplide(banner) {
            banner.element.querySelector('.amp-banner').classList.add('splide__track')
            banner.element.querySelector('.amp-banner__list').classList.add('splide__list');
            banner.element.querySelectorAll('.amp-banner__item').forEach(item => {
                item.classList.add('splide__slide');
            });
            banner.element.classList.add('splide');

            new Splide(banner.element, {
                type: 'loop',
                autoplay: true,
                interval: banner.data.rotationSeconds * 1000,
            }).mount();
        }

        function initSwiper(banner) {
            const lists = banner.element.getElementsByClassName('amp-banner__list');

            for (let list of lists) {
                const wrapper = document.createElement('div');
                const items = Array.from(list.getElementsByClassName('amp-banner__item'));

                list.innerHTML = '';
                list.classList.add('swiper');
                wrapper.classList.add('swiper-wrapper');

                for (let item of items) {
                    item.classList.add('swiper-slide');
                    wrapper.insertAdjacentElement('beforeend', item);
                }

                list.insertAdjacentElement('beforeend', wrapper);

                const prevButton = document.createElement('a');
                const nextButton = document.createElement('a');
                const pagination = document.createElement('div');

                prevButton.href = 'javascript:;';
                nextButton.href = 'javascript:;';
                prevButton.classList.add('swiper-button-prev');
                nextButton.classList.add('swiper-button-next');
                pagination.classList.add('swiper-pagination');

                list.insertAdjacentElement('beforeend', prevButton);
                list.insertAdjacentElement('beforeend', nextButton);
                list.insertAdjacentElement('beforeend', pagination);

                new Swiper(list, {
                    autoplay: {
                        delay: 5e3,
                        pauseOnMouseEnter: false,
                        disableOnInteraction: false
                    },
                    watchSlidesProgress: true,
                    slidesPerView: 1,
                    grabCursor: true,
                    speed: 900,
                    keyboard: {
                        enabled: true
                    },
                    pagination: {
                        el: '.swiper-pagination'
                    },
                    navigation: {
                        nextEl: '.swiper-button-next',
                        prevEl: '.swiper-button-prev'
                    },
                    breakpoints: {
                        320: {
                            slidesPerView: 'auto',
                            spaceBetween: 10
                        },
                        640: {
                            slidesPerView: 1,
                            spaceBetween: 0
                        },
                        1e3: {
                            slidesPerView: 1,
                            spaceBetween: 0
                        }
                    },
                    rewind: false,
                    loop: true,
                    cssMode: false,
                    loopedSlides: 1,
                });
            }
        }

        window.AMPClient.on('amp:banner:state-changed', function (banner) {
            if ('RENDERED' !== banner.state || 'multiple' !== banner.data.displayType) {
                return;
            }

            if (banner.element.classList.contains('slider--splide')) {
                initSplide(banner);
            }

            if (banner.element.classList.contains('slider--swiper')) {
                initSwiper(banner);
            }
        });

        AMPClient.attachBanners();
        AMPClient.fetch();
    </script>
</body>
</html>
